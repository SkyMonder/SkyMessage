<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>SkyMessage ‚Äî –ß–∞—Ç—ã</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body { margin:0; font-family:sans-serif; background:#111; color:#eee; display:flex; height:100vh; }
aside { width:300px; background:#222; border-right:1px solid #333; display:flex; flex-direction:column; }
header, footer { background:#222; border-bottom:1px solid #333; padding:10px; }
#chatList { flex:1; overflow-y:auto; padding:0; margin:0; list-style:none; }
#chatList li { padding:10px; border-bottom:1px solid #333; cursor:pointer; }
#messages { flex:1; overflow-y:auto; padding:10px; }
.message { padding:8px; border-radius:10px; margin-bottom:5px; max-width:70%; }
.message.mine { background:#0f0; margin-left:auto; text-align:right; }
.message.peer { background:#333; text-align:left; }
input, button { padding:8px; border-radius:8px; border:none; }
input { flex:1; margin-right:5px; }
footer { display:flex; }
video { border:2px solid #555; border-radius:10px; position:absolute; right:20px; bottom:20px; }
#remoteVideo { width:320px; height:240px; display:none; }
#localVideo { width:160px; height:120px; display:none; }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
</head>
<body>

<aside>
  <header>
    <div>SkyMessage</div>
  </header>
  <div style="padding:10px;">
    <input id="searchInput" placeholder="–ù–∞–π—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
    <button id="searchBtn">üîç</button>
    <div id="searchResult" style="margin-top:5px;"></div>
  </div>
  <ul id="chatList"></ul>
</aside>

<main style="flex:1; display:flex; flex-direction:column;">
  <header id="chatHeader">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</header>
  <div id="messages"></div>
  <footer>
    <input id="msgInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ">
    <button id="sendBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    <button id="callBtn">üìû –ó–≤–æ–Ω–æ–∫</button>
  </footer>
</main>

<video id="localVideo" autoplay muted></video>
<video id="remoteVideo" autoplay></video>

<script>
let me = null;
let selectedChatId = null;
const socket = io();

function fmtTime(iso){ return iso ? new Date(iso).toLocaleTimeString() : ''; }

async function fetchMe(){ const r = await fetch('/api/me'); me=(await r.json()).user; }
async function fetchChats(){
  const r = await fetch('/api/chats'); const chats = await r.json();
  const list = document.getElementById('chatList'); list.innerHTML='';
  chats.forEach(c=>{
    const li = document.createElement('li');
    li.textContent = c.name || "–ë–µ–∑ –∏–º–µ–Ω–∏";
    li.onclick=()=>selectChat(c.id,c.name);
    list.appendChild(li);
  });
}

async function selectChat(id,name){
  selectedChatId = id;
  document.getElementById('chatHeader').textContent=name;
  const r = await fetch('/api/messages/'+id);
  const msgs = await r.json();
  const messagesDiv = document.getElementById('messages');
  messagesDiv.innerHTML='';
  msgs.forEach(m=>renderMsg(m));
}

function renderMsg(m){
  const div=document.createElement('div');
  div.className='message '+(m.sender_id===me.id?'mine':'peer');
  div.innerHTML = `<div>${m.text}</div><div style="font-size:10px;color:#888">${fmtTime(m.timestamp)}</div>`;
  document.getElementById('messages').appendChild(div);
  document.getElementById('messages').scrollTop = 99999;
}

// --- –û—Ç–ø—Ä–∞–≤–∫–∞ ---
document.getElementById('sendBtn').onclick = async ()=>{
  const text=document.getElementById('msgInput').value.trim();
  if(!text || !selectedChatId) return;
  const r = await fetch('/api/send_message',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({chat_id:selectedChatId, text})
  });
  if(r.ok) document.getElementById('msgInput').value='';
};

// --- –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π ---
document.getElementById('searchBtn').onclick = async ()=>{
  const q = document.getElementById('searchInput').value.trim();
  const res = document.getElementById('searchResult');
  if(!q){ res.textContent='–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω'; return; }
  res.textContent='–ü–æ–∏—Å–∫...';
  const r = await fetch('/api/users?q='+encodeURIComponent(q));
  const users = await r.json();
  if(users.length===0){ res.textContent='–ù–∏–∫—Ç–æ –Ω–µ –Ω–∞–π–¥–µ–Ω'; return; }
  const u = users[0];
  res.innerHTML=`–ù–∞–π–¥–µ–Ω: <b>@${u.username}</b> <button id="startChat">–û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç</button>`;
  document.getElementById('startChat').onclick = async ()=>{
    const r2 = await fetch('/api/create_chat',{
      method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({user_ids:[u.id]})
    });
    const j2 = await r2.json();
    await fetchChats();
    selectChat(j2.chat_id,u.username);
  };
}

// --- WebRTC –∑–≤–æ–Ω–∫–∏ ---
let pc, localStream;

document.getElementById('callBtn').onclick = async ()=>{
  if(!selectedChatId) return alert("–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç");
  localStream = await navigator.mediaDevices.getUserMedia({video:true,audio:true});
  document.getElementById('localVideo').srcObject=localStream;
  document.getElementById('localVideo').style.display='block';

  pc = new RTCPeerConnection({iceServers:[{urls:'stun:stun.l.google.com:19302'}]});
  localStream.getTracks().forEach(track=>pc.addTrack(track,localStream));
  pc.ontrack = e => { document.getElementById('remoteVideo').srcObject = e.streams[0]; document.getElementById('remoteVideo').style.display='block'; };
  pc.onicecandidate = e => { if(e.candidate) socket.emit('webrtc_ice',{candidate:e.candidate, chat_id:selectedChatId}); };

  const offer = await pc.createOffer(); await pc.setLocalDescription(offer);
  socket.emit('webrtc_offer',{sdp:offer, chat_id:selectedChatId});
}

// --- Socket.IO —Å–∏–≥–Ω–∞–ª–∏–∑–∞—Ü–∏—è ---
socket.on('webrtc_offer', async m=>{
  if(m.chat_id!==selectedChatId) return;
  localStream = await navigator.mediaDevices.getUserMedia({video:true,audio:true});
  document.getElementById('localVideo').srcObject = localStream; document.getElementById('localVideo').style.display='block';

  pc = new RTCPeerConnection({iceServers:[{urls:'stun:stun.l.google.com:19302'}]});
  localStream.getTracks().forEach(track=>pc.addTrack(track,localStream));
  pc.ontrack = e => { document.getElementById('remoteVideo').srcObject = e.streams[0]; document.getElementById('remoteVideo').style.display='block'; };
  pc.onicecandidate = e => { if(e.candidate) socket.emit('webrtc_ice',{candidate:e.candidate, chat_id:selectedChatId}); };

  await pc.setRemoteDescription(new RTCSessionDescription(m.sdp));
  const answer = await pc.createAnswer(); await pc.setLocalDescription(answer);
  socket.emit('webrtc_answer',{sdp:answer, chat_id:selectedChatId});
});

socket.on('webrtc_answer', async m=>{ await pc.setRemoteDescription(new RTCSessionDescription(m.sdp)); });
socket.on('webrtc_ice', m=>{ if(pc) pc.addIceCandidate(new RTCIceCandidate(m.candidate)); });

// --- –°–æ–æ–±—â–µ–Ω–∏—è ---
socket.on('message', m => { if(m.chat_id===selectedChatId) renderMsg(m); else fetchChats(); });

// --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---
(async()=>{ await fetchMe(); await fetchChats(); })();
</script>
</body>
</html>

<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>–ß–∞—Ç—ã ‚Äî SkyMessage</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { margin:0; font-family:sans-serif; background:#111; color:#eee; }
    aside { width:320px; background:#222; border-right:1px solid #333; display:flex; flex-direction:column; }
    header, footer { height:60px; background:#222; border-bottom:1px solid #333; display:flex; align-items:center; padding:0 10px; }
    main { flex:1; display:flex; flex-direction:column; }
    #chatList { flex:1; overflow-y:auto; }
    li { padding:10px; cursor:pointer; border-bottom:1px solid #333; }
    li:hover { background:#333; }

    /* –°–æ–æ–±—â–µ–Ω–∏—è */
    #messages { flex:1; overflow-y:auto; padding:10px; display:flex; flex-direction:column; }
    .msg {
      max-width:70%;
      padding:8px 12px;
      border-radius:15px;
      margin:5px 0;
      word-wrap: break-word;
      display: inline-block;
    }
    .mine { background:#00bfa5; align-self:flex-end; color:#fff; }
    .peer { background:#444; align-self:flex-start; color:#fff; }
    small { display:block; font-size:0.7em; color:#aaa; margin-top:2px; }

    /* –ó–≤–æ–Ω–∫–∏ */
    #call { background:#222; border-top:1px solid #333; padding:10px; display:none; }
    video { background:#000; margin-right:5px; }
    #call div button { margin-right:5px; margin-top:5px; }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
</head>
<body>
  <div style="display:flex; height:100vh;">
    <aside>
      <div style="padding:10px; border-bottom:1px solid #333;">
        <strong>SkyMessage</strong>
      </div>
      <div style="padding:10px; border-bottom:1px solid #333;">
        <input id="searchInput" placeholder="–ù–∞–π—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è..." style="width:70%; padding:5px;" />
        <button id="searchBtn">–ù–∞–π—Ç–∏</button>
        <div id="searchResult"></div>
      </div>
      <ul id="chatList"></ul>
    </aside>
    <main>
      <header id="chatHeader">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</header>
      <section id="messages"></section>

      <section id="call">
        <video id="localVideo" autoplay muted style="width:160px; height:120px;"></video>
        <video id="remoteVideo" autoplay style="width:160px; height:120px;"></video>
        <div>
          <button id="acceptCall">‚úÖ –ü—Ä–∏–Ω—è—Ç—å</button>
          <button id="rejectCall">‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
          <button id="endCall">üì¥ –ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
          <button id="toggleMic">üé§ –ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤—ã–∫–ª</button>
          <button id="toggleCam">üì∑ –ö–∞–º–µ—Ä–∞ –≤—ã–∫–ª</button>
        </div>
      </section>

      <footer>
        <input id="msgInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." style="flex:1; padding:5px;" />
        <button id="sendBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </footer>
    </main>
  </div>

<script>
let me = null;
let chats = [];
let selectedChatId = null;
let localStream, peerConnection, remoteUser;

const socket = io();

// --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ ---
function fmtTime(iso){ return iso ? new Date(iso).toLocaleTimeString() : ''; }
async function fetchMe(){ 
  const r = await fetch('/api/me'); 
  const data = await r.json();
  if(data.user) me = data.user; 
  socket.emit("register",{username:me.username});
}

// --- –ß–∞—Ç—ã ---
async function fetchChats(){
  const r = await fetch('/api/chats'); 
  chats = await r.json();
  const list = document.getElementById('chatList'); 
  list.innerHTML='';
  chats.forEach(c=>{
    const li = document.createElement('li');
    li.textContent = c.name+' - '+(c.last.text||'');
    li.onclick = ()=>selectChat(c.id,c.name);
    list.appendChild(li);
  });
}

// --- –í—ã–±–æ—Ä —á–∞—Ç–∞ ---
async function selectChat(id,name){
  selectedChatId=id;
  document.getElementById('chatHeader').textContent=name;
  document.getElementById('messages').innerHTML='';
  socket.emit('join_chat',{chat_id:id});
  const r=await fetch('/api/messages/'+id); 
  const msgs=await r.json();
  msgs.forEach(renderMsg);
}

// --- –†–µ–Ω–¥–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π ---
function renderMsg(m){
  const div = document.createElement('div');
  div.className = 'msg '+(m.sender_id===me.id?'mine':'peer');
  div.textContent = m.text;
  const time = document.createElement('small');
  time.textContent = fmtTime(m.timestamp);
  div.appendChild(time);
  document.getElementById('messages').appendChild(div);
  document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
}

// --- –û—Ç–ø—Ä–∞–≤–∫–∞ ---
document.getElementById('sendBtn').onclick = async ()=>{
  const text=document.getElementById('msgInput').value.trim();
  if(!text || !selectedChatId) return;
  await fetch('/api/send_message',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({chat_id:selectedChatId,text})
  });
  document.getElementById('msgInput').value='';
};

// --- –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ —Å–æ–∑–¥–∞–Ω–∏–µ —á–∞—Ç–∞ ---
document.getElementById('searchBtn').onclick = async ()=>{
  const q=document.getElementById('searchInput').value.trim();
  const res=document.getElementById('searchResult'); 
  res.textContent='...';
  const r=await fetch('/api/users?q='+encodeURIComponent(q));
  const users=await r.json();
  if(!users.length){ res.textContent='–ù–∏–∫–æ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ'; return; }
  res.innerHTML='';
  users.forEach(u=>{
    const btn=document.createElement('button');
    btn.textContent='@'+u.username;
    btn.onclick=async()=>{
      const cr=await fetch('/api/create_chat',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({user_ids:[u.id]})
      });
      const data=await cr.json();
      if(data.ok && data.chat_id){
        await fetchChats();
        selectChat(data.chat_id,'@'+u.username);
        res.textContent='';
      }
    };
    res.appendChild(btn);
  });
};

// --- –ó–≤–æ–Ω–∫–∏ ---
async function startCall(toUser) {
  remoteUser = toUser;
  localStream = await navigator.mediaDevices.getUserMedia({video:true,audio:true});
  document.getElementById('localVideo').srcObject = localStream;

  peerConnection = new RTCPeerConnection();
  localStream.getTracks().forEach(track=>peerConnection.addTrack(track,localStream));
  peerConnection.ontrack = e=>{ document.getElementById('remoteVideo').srcObject = e.streams[0]; };

  const offer = await peerConnection.createOffer();
  await peerConnection.setLocalDescription(offer);
  socket.emit('call_user',{to:toUser, from:me.username, offer});
  document.getElementById('call').style.display='block';
}

socket.on('incoming_call', async data=>{
  remoteUser=data.from;
  document.getElementById('call').style.display='block';

  document.getElementById('acceptCall').onclick = async ()=>{
    localStream = await navigator.mediaDevices.getUserMedia({video:true,audio:true});
    document.getElementById('localVideo').srcObject = localStream;

    peerConnection = new RTCPeerConnection();
    localStream.getTracks().forEach(track=>peerConnection.addTrack(track,localStream));
    peerConnection.ontrack = e=>{ document.getElementById('remoteVideo').srcObject = e.streams[0]; };

    await peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer));
    const answer = await peerConnection.createAnswer();
    await peerConnection.setLocalDescription(answer);

    socket.emit('answer_call',{to:remoteUser, from:me.username, accepted:true, answer});
  };

  document.getElementById('rejectCall').onclick = ()=>{
    socket.emit('answer_call',{to:remoteUser, from:me.username, accepted:false});
    endCall();
  };
});

socket.on('call_answered', async data=>{
  if(data.accepted){
    await peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
  } else {
    alert('–ó–≤–æ–Ω–æ–∫ –æ—Ç–∫–ª–æ–Ω—ë–Ω');
    endCall();
  }
});

document.getElementById('endCall').onclick = ()=>{
  socket.emit('end_call',{to:remoteUser, from:me.username});
  endCall();
};
socket.on('call_ended', endCall);

function endCall(){
  if(peerConnection) peerConnection.close();
  if(localStream) localStream.getTracks().forEach(t=>t.stop());
  peerConnection=null; localStream=null;
  document.getElementById('call').style.display='none';
}

document.getElementById('toggleMic').onclick = ()=>{
  if(!localStream) return;
  const track = localStream.getAudioTracks()[0];
  track.enabled = !track.enabled;
  document.getElementById('toggleMic').textContent = track.enabled ? 'üé§ –ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤—ã–∫–ª' : 'üé§ –ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤–∫–ª';
};

document.getElementById('toggleCam').onclick = ()=>{
  if(!localStream) return;
  const track = localStream.getVideoTracks()[0];
  track.enabled = !track.enabled;
  document.getElementById('toggleCam').textContent = track.enabled ? 'üì∑ –ö–∞–º–µ—Ä–∞ –≤—ã–∫–ª' : 'üì∑ –ö–∞–º–µ—Ä–∞ –≤–∫–ª';
};

// --- Socket.IO ---
socket.on('message', m=>{ if(m.chat_id===selectedChatId) renderMsg(m); else fetchChats(); });
socket.on('new_chat', ()=>fetchChats());

// --- Init ---
(async function(){ await fetchMe(); await fetchChats(); })();
</script>
</body>
</html>

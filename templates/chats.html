<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>SkyMessage</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body {margin:0;font-family:sans-serif;background:#1e1e2f;color:#eee;display:flex;height:100vh;}
aside {width:300px;background:#2b2b3b;display:flex;flex-direction:column;border-right:1px solid #444;}
header, footer {height:60px;background:#2b2b3b;display:flex;align-items:center;padding:0 15px;border-bottom:1px solid #444;}
#chatHeader {border-bottom:1px solid #444;}
#messages {flex:1;overflow-y:auto;padding:15px;}
input, button {padding:8px;border:none;border-radius:8px;}
input {flex:1;background:#3c3c4d;color:#eee;}
button {background:#4c4cff;color:#fff;margin-left:5px;cursor:pointer;}
.chat-item {padding:10px;border-bottom:1px solid #444;cursor:pointer;}
.chat-item:hover {background:#3c3c4d;}
.message {margin-bottom:10px;padding:10px;border-radius:10px;max-width:70%;}
.mine {background:#4caf50;margin-left:auto;text-align:right;}
.theirs {background:#555;text-align:left;margin-right:auto;}
video {border:1px solid #444;position:absolute;}
#localVideo {width:120px;height:120px;bottom:10px;right:10px;display:none;}
#remoteVideo {width:200px;height:200px;bottom:140px;right:10px;display:none;}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
</head>
<body>
<aside>
  <div style="padding:15px;border-bottom:1px solid #444;">SkyMessage</div>
  <div style="padding:10px;">
    <input id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...">
    <button id="searchBtn">–ù–∞–π—Ç–∏</button>
    <div id="searchResult"></div>
  </div>
  <ul id="chatList" style="flex:1;overflow-y:auto;"></ul>
</aside>
<main style="flex:1;display:flex;flex-direction:column;">
  <header id="chatHeader">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</header>
  <div id="messages" style="flex:1;overflow-y:auto;"></div>
  <footer style="display:flex;padding:10px;">
    <input id="msgInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ...">
    <button id="sendBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    <button id="callBtn">üìû</button>
  </footer>
  <video id="localVideo" autoplay muted></video>
  <video id="remoteVideo" autoplay></video>
</main>

<script>
let me=null, chats=[], selectedChatId=null, socket=io();
let localStream=null, pc=null;

async function fetchMe(){
    let r=await fetch('/api/me'); 
    me=(await r.json()).user;
}
async function fetchChats(){
    let r=await fetch('/api/chats'); 
    chats=await r.json(); 
    let list=document.getElementById('chatList'); 
    list.innerHTML='';
    chats.forEach(c=>{
        let li=document.createElement('li'); 
        li.textContent=c.name; 
        li.className='chat-item'; 
        li.onclick=()=>selectChat(c.id); 
        list.appendChild(li);
    });
}
function selectChat(id){
    selectedChatId=id;
    document.getElementById('chatHeader').textContent=chats.find(c=>c.id===id).name;
    fetchMessages();
    socket.emit('join_chat',{chat_id:id});
}
async function fetchMessages(){
    if(!selectedChatId) return;
    let r=await fetch('/api/messages/'+selectedChatId);
    let msgs=await r.json();
    let container=document.getElementById('messages');
    container.innerHTML='';
    msgs.forEach(m=>addMessage(m));
    container.scrollTop=container.scrollHeight;
}
function addMessage(m){
    let div=document.createElement('div');
    div.textContent=m.text;
    div.className='message '+(m.sender_id===me.id?'mine':'theirs');
    document.getElementById('messages').appendChild(div);
    document.getElementById('messages').scrollTop=document.getElementById('messages').scrollHeight;
}
document.getElementById('sendBtn').onclick=async ()=>{
    let text=document.getElementById('msgInput').value;
    if(!text || !selectedChatId) return;
    let r=await fetch('/api/send_message',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({chat_id:selectedChatId,text})
    });
    document.getElementById('msgInput').value='';
};
socket.on('message',m=>{
    if(m.chat_id===selectedChatId) addMessage(m);
});

// –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
document.getElementById('searchBtn').onclick=async ()=>{
    let query=document.getElementById('searchInput').value;
    if(!query) return;
    let r=await fetch('/api/users?q='+query);
    let data=await r.json();
    let resDiv=document.getElementById('searchResult');
    resDiv.innerHTML='';
    data.forEach(u=>{
        let btn=document.createElement('button');
        btn.textContent=u.username;
        btn.onclick=async ()=>{
            let cr=await fetch('/api/create_chat',{
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body:JSON.stringify({user_ids:[u.id]})
            });
            await fetchChats();
        };
        resDiv.appendChild(btn);
    });
};

// WebRTC –∑–≤–æ–Ω–∫–∏
async function startCall(){
    pc=new RTCPeerConnection();
    localStream=await navigator.mediaDevices.getUserMedia({video:true,audio:true});
    localStream.getTracks().forEach(track=>pc.addTrack(track,localStream));
    document.getElementById('localVideo').srcObject=localStream;
    document.getElementById('localVideo').style.display='block';
    pc.ontrack=e=>{
        document.getElementById('remoteVideo').srcObject=e.streams[0];
        document.getElementById('remoteVideo').style.display='block';
    };
    pc.onicecandidate=e=>{if(e.candidate) socket.emit('webrtc_ice',{chat_id:selectedChatId,candidate:e.candidate});};
    let offer=await pc.createOffer();
    await pc.setLocalDescription(offer);
    socket.emit('webrtc_offer',{chat_id:selectedChatId,sdp:offer});
}

document.getElementById('callBtn').onclick=startCall;

socket.on('webrtc_offer',async data=>{
    if(data.chat_id!==selectedChatId) return;
    pc=new RTCPeerConnection();
    localStream=await navigator.mediaDevices.getUserMedia({video:true,audio:true});
    localStream.getTracks().forEach(track=>pc.addTrack(track,localStream));
    document.getElementById('localVideo').srcObject=localStream;
    document.getElementById('localVideo').style.display='block';
    pc.ontrack=e=>{
        document.getElementById('remoteVideo').srcObject=e.streams[0];
        document.getElementById('remoteVideo').style.display='block';
    };
    pc.onicecandidate=e=>{if(e.candidate) socket.emit('webrtc_ice',{chat_id:selectedChatId,candidate:e.candidate});};
    await pc.setRemoteDescription(data.sdp);
    let answer=await pc.createAnswer();
    await pc.setLocalDescription(answer);
    socket.emit('webrtc_answer',{chat_id:selectedChatId,sdp:answer});
});

socket.on('webrtc_answer',async data=>{
    if(data.chat_id!==selectedChatId) return;
    await pc.setRemoteDescription(data.sdp);
});

socket.on('webrtc_ice',async data=>{
    if(data.chat_id!==selectedChatId) return;
    try{await pc.addIceCandidate(data.candidate);}catch(e){console.error(e);}
});

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
(async()=>{
    await fetchMe();
    await fetchChats();
})();
</script>
</body>
</html>

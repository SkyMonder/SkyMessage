<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>Чаты — SkyMessage</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { margin:0; font-family:sans-serif; background:#111; color:#eee; }
    aside { width:320px; background:#222; border-right:1px solid #333; display:flex; flex-direction:column; }
    header, footer { height:60px; background:#222; border-bottom:1px solid #333; display:flex; align-items:center; padding:0 10px; }
    main { flex:1; display:flex; flex-direction:column; }
    #chatList { flex:1; overflow-y:auto; }
    li { padding:10px; cursor:pointer; border-bottom:1px solid #333; }
    li:hover { background:#333; }
    .msg { max-width:70%; padding:8px; border-radius:10px; margin:5px 0; display:inline-block; }
    .mine { background:#0f0; margin-left:auto; text-align:right; }
    .peer { background:#444; margin-right:auto; text-align:left; }
    #messages { flex:1; overflow-y:auto; padding:10px; }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
</head>
<body>
  <div style="display:flex; height:100vh;">
    <aside>
      <div style="padding:10px; border-bottom:1px solid #333;">
        <strong>SkyMessage</strong>
      </div>
      <div style="padding:10px; border-bottom:1px solid #333;">
        <input id="searchInput" placeholder="Найти пользователя..." style="width:70%; padding:5px;" />
        <button id="searchBtn">Найти</button>
        <div id="searchResult"></div>
      </div>
      <ul id="chatList"></ul>
    </aside>
    <main>
      <header id="chatHeader">Выберите чат</header>
      <section id="messages"></section>
      <footer>
        <input id="msgInput" placeholder="Сообщение..." style="flex:1; padding:5px;" />
        <button id="sendBtn">Отправить</button>
      </footer>
    </main>
  </div>

<script>
let me = null;
let chats = [];
let selectedChatId = null;
const socket = io();

// --- Вспомогательные ---
function fmtTime(iso){ return iso ? new Date(iso).toLocaleTimeString() : ''; }
async function fetchMe(){ const r=await fetch('/api/me'); me=(await r.json()).user; }

// --- Чаты ---
async function fetchChats(){
  const r=await fetch('/api/chats'); chats=await r.json();
  const list=document.getElementById('chatList'); list.innerHTML='';
  chats.forEach(c=>{
    const li=document.createElement('li');
    li.textContent=c.name+' - '+(c.last.text||'');
    li.onclick=()=>selectChat(c.id,c.name);
    list.appendChild(li);
  });
}

// --- Выбор чата ---
async function selectChat(id,name){
  selectedChatId=id;
  document.getElementById('chatHeader').textContent=name;
  document.getElementById('messages').innerHTML='';
  socket.emit('join_chat',{chat_id:id});
  const r=await fetch('/api/messages/'+id); const msgs=await r.json();
  msgs.forEach(renderMsg);
}

// --- Рендер сообщений ---
function renderMsg(m){
  const div=document.createElement('div');
  div.className='msg '+(m.sender_id===me.id?'mine':'peer');
  div.innerHTML=m.text+'<br><small>'+fmtTime(m.timestamp)+'</small>';
  document.getElementById('messages').appendChild(div);
  document.getElementById('messages').scrollTop=document.getElementById('messages').scrollHeight;
}

// --- Отправка ---
document.getElementById('sendBtn').onclick=async()=>{
  const text=document.getElementById('msgInput').value.trim();
  if(!text || !selectedChatId) return;
  const r=await fetch('/api/send_message',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({chat_id:selectedChatId,text})
  });
  document.getElementById('msgInput').value='';
};

// --- Поиск пользователей ---
document.getElementById('searchBtn').onclick=async()=>{
  const q=document.getElementById('searchInput').value.trim();
  const res=document.getElementById('searchResult'); res.textContent='...';
  const r=await fetch('/api/users?q='+encodeURIComponent(q));
  const users=await r.json();
  if(!users.length){ res.textContent='Никого не найдено'; return; }
  res.innerHTML='';
  users.forEach(u=>{
    const btn=document.createElement('button');
    btn.textContent='@'+u.username;
    btn.onclick=async()=>{
      const cr=await fetch('/api/create_chat',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({user_ids:[u.id]})
      });
      const data=await cr.json();
      if(data.ok && data.chat_id){
        await fetchChats();
        selectChat(data.chat_id,'@'+u.username);
        res.textContent='';
      }
    };
    res.appendChild(btn);
  });
};

// --- Socket.IO ---
socket.on('connect',()=>{});
socket.on('message',m=>{ if(m.chat_id===selectedChatId) renderMsg(m); else fetchChats(); });
socket.on('new_chat',()=>fetchChats());

// --- Инициализация ---
(async function(){ await fetchMe(); await fetchChats(); })();
</script>
</body>
</html>

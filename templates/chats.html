<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<title>–ß–∞—Ç—ã ‚Äî SkyMessage</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
body { margin:0; font-family:sans-serif; background:#111; color:#eee; }
aside { width:320px; background:#222; border-right:1px solid #333; display:flex; flex-direction:column; }
header, footer { height:60px; background:#222; border-bottom:1px solid #333; display:flex; align-items:center; padding:0 10px; }
main { flex:1; display:flex; flex-direction:column; }
#chatList { flex:1; overflow-y:auto; }
li { padding:10px; cursor:pointer; border-bottom:1px solid #333; }
li:hover { background:#333; }
.msg { max-width:70%; padding:8px; border-radius:10px; margin:5px 0; display:block; clear:both; }
.mine { background:#0f0; margin-left:auto; text-align:right; }
.peer { background:#444; margin-right:auto; text-align:left; }
#messages { flex:1; overflow-y:auto; padding:10px; }
#call { background:#222; border-top:1px solid #333; padding:10px; display:none; }
video { width:160px; height:120px; background:#000; margin-right:5px; }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
</head>
<body>
<div style="display:flex; height:100vh;">
<aside>
  <div style="padding:10px; border-bottom:1px solid #333;"><strong>SkyMessage</strong></div>
  <div style="padding:10px; border-bottom:1px solid #333;">
    <input id="searchInput" placeholder="–ù–∞–π—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è..." style="width:70%; padding:5px;" />
    <button id="searchBtn">–ù–∞–π—Ç–∏</button>
    <div id="searchResult"></div>
  </div>
  <ul id="chatList"></ul>
</aside>
<main>
<header id="chatHeader">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</header>
<section id="messages"></section>

<section id="call">
  <video id="localVideo" autoplay muted></video>
  <video id="remoteVideo" autoplay></video>
  <div>
    <button id="acceptCall">‚úÖ</button>
    <button id="rejectCall">‚ùå</button>
    <button id="endCall">üì¥</button>
    <button id="toggleMic">üé§</button>
    <button id="toggleCam">üì∑</button>
  </div>
</section>

<footer>
  <form id="msgForm" style="flex:1; display:flex;">
    <input id="msgInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." style="flex:1; padding:5px;" />
    <input type="file" id="fileInput" />
    <button>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
  </form>
  <button id="callBtn">–ü–æ–∑–≤–æ–Ω–∏—Ç—å</button>
</footer>
</main>
</div>

<script>
let me=null, chats=[], selectedChatId=null;
const socket = io();

// --- INIT ---
async function fetchMe(){ const r=await fetch('/api/me'); me=(await r.json()).user; socket.emit("register",{username:me.username}); }
async function fetchChats(){
  const r=await fetch('/api/chats'); chats=await r.json();
  const list=document.getElementById('chatList'); list.innerHTML='';
  chats.forEach(c=>{
    const li=document.createElement('li');
    li.textContent=c.name+' - '+(c.last.text||'');
    li.onclick=()=>selectChat(c.id,c.name);
    list.appendChild(li);
  });
}

// --- CHAT ---
async function selectChat(id,name){
  selectedChatId=id;
  document.getElementById('chatHeader').textContent=name;
  document.getElementById('messages').innerHTML='';
  socket.emit('join_chat',{chat_id:id});
  const r=await fetch('/api/messages/'+id); const msgs=await r.json();
  msgs.forEach(renderMsg);
}

function renderMsg(m){
  const div=document.createElement('div');
  div.className='msg '+(m.sender_id===me.id?'mine':'peer');
  div.innerHTML=m.text + (m.file?'<br><a href="/uploads/'+m.file+'" target="_blank">–§–∞–π–ª</a>':'');
  document.getElementById('messages').appendChild(div);
  document.getElementById('messages').scrollTop=document.getElementById('messages').scrollHeight;
}

// --- SEND MESSAGE ---
document.getElementById('msgForm').onsubmit=async e=>{
  e.preventDefault();
  if(!selectedChatId) return;
  const form = new FormData();
  form.append('chat_id', selectedChatId);
  form.append('text', document.getElementById('msgInput').value);
  const file = document.getElementById('fileInput').files[0];
  if(file) form.append('file', file);
  await fetch('/api/send_message',{method:'POST', body:form});
  document.getElementById('msgInput').value='';
  document.getElementById('fileInput').value='';
};

// --- SEARCH ---
document.getElementById('searchBtn').onclick=async()=>{
  const q=document.getElementById('searchInput').value;
  const r=document.getElementById('searchResult'); r.textContent='...';
  const res = await fetch('/api/users?q='+q); const users=await res.json();
  r.innerHTML='';
  users.forEach(u=>{
    const btn=document.createElement('button'); btn.textContent='@'+u.username;
    btn.onclick=async()=>{
      const cr = await fetch('/api/create_chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({user_ids:[u.id]})});
      const data = await cr.json();
      if(data.ok){ await fetchChats(); selectChat(data.chat_id,'@'+u.username); r.textContent=''; }
    };
    r.appendChild(btn);
  });
};

// --- SOCKET.IO ---
socket.on('message', m=>{ if(m.chat_id===selectedChatId) renderMsg(m); else fetchChats(); });
socket.on('new_chat',()=>fetchChats());

(async()=>{ await fetchMe(); await fetchChats(); })();
</script>
</body>
</html>
